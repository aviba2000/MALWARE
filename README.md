# MALWARE

Malware Project

## Developing Log4Shell Attack
RMI allows using remote objects if:
* It's defined in the classpath.
* It's downloaded using a stub.

Before Java SE 8 and JEP 290 it was possible using a stub that downloaded the remote object from the server. During development of the attack, the stub was getting downloaded but the URLClassLoader was unable to find the codebase (source code of the payload). Now we need "gadgets" loaded in the classpath of the target. Luckily, Apache Tomcat has a org.apache.naming.factory.BeanFactory.

Info:
* RCE Overview: https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf
* JNDI Overview: https://docs.oracle.com/javase/tutorial/jndi/overview/index.html
* Serializable Objects: https://docs.oracle.com/javase/tutorial/jndi/objects/serial.html
* RMI Codebase Docs: https://docs.oracle.com/javase/8/docs/technotes/guides/rmi/codebase.html
* Explanation: https://www.veracode.com/blog/research/exploiting-jndi-injections-java

The gadget we used requires forceString function. Tomcat 8.5.79 disables forceString. The attack window is from the discovery of Log4Shell (4th November 2021) to the Tomcat patch (23th May 2022). Around 6 months. We compiled the attack with JDK 11 and:
```
--add-exports jdk.naming.rmi/com.sun.jndi.rmi.registry=ALL-UNNAMED --add-modules jdk.naming.rmi
```
We also used `tomcat-catalina.jar`.

Info:
* Tomcat 8.5.x Changelog: https://tomcat.apache.org/tomcat-8.5-doc/changelog.html
